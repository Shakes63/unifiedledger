COMPLETED BUGS:
✅ 1. the category and accounts dropdown on the bill form are not connected to the categories and accounts
✅ 2. when creating a new transaction the default date should be today
✅ 3. There should be a way to mark an account as being a Business Account and that should trigger the sales tax tracking for that account.
✅ 4. If there are multiple business accounts the sales tax should be tracked separately.
✅ 5. Everywhere that you can add a category or tag there should be an option to create them inline.
✅ 6. there should be some padding in between the sidebar and the page content. The dashboard is a good example of the amount of padding it should have. Check all of the pages and ensure the padding is like the dashboard page.
✅ 7. When trying to create an account the submit button is not creating the account.
✅ 8. the dropdowns across the app are completely transparent, turn up the opacity so that they can be read easier.
✅ 9. when creating a transaction there should only be a transfer type instead of transfer in and transfer out. If Transfer is selected it should show a From Account and To Account dropdowns.
✅ 10. the transaction form is doubled up there should only be one.
✅ 11. make the cards on the categories page more compact.
✅ 12. Account creation was failing with 500 error - fixed missing is_business_account database column
✅ 13. Sidebar dashboard was highlighted even when a different option was selected - fixed isActive() function
✅ 14. Transfer form showed duplicate "Account" labels - fixed by making AccountSelector label customizable
✅ 15. Category cards were too large - made them significantly smaller (p-2, reduced fonts, gap-2)
✅ 16. Categories couldn't be marked as tax deductible - added isTaxDeductible field and toggle UI
✅ 17. BillsWidget error "data.filter is not a function" - API returns {data: [...], total, limit, offset} but component expected array. Fixed by extracting data.data and handling both array and object responses
✅ 18. Added Merchant field to transactions with inline creation feature:
   - Added merchantId field to transactions table in schema
   - Created database migration 0005_add_merchant_id.sql
   - Enhanced /api/merchants/route.ts with POST endpoint for creating merchants
   - Created /api/merchants/[id]/route.ts for PUT (update) and DELETE operations
   - Created MerchantSelector component with inline creation (similar to CategorySelector)
   - Integrated MerchantSelector into TransactionForm (hidden for transfers)
   - Created full Merchants management page at /dashboard/merchants with list, edit, delete, create
   - Added "Merchants" link to sidebar in Tools section
   - Merchants support usage count tracking and are sorted by usage

✅ 19. Separated merchants and description fields:
   - Removed MerchantAutocomplete from description field
   - Description field is now plain Input component
   - Merchant field is selected via separate MerchantSelector component
   - Merchant suggestions no longer appear in description field

✅ 20. Fixed internal server error when selecting description from dropdown:
   - Root cause: MerchantAutocomplete suggestion dropdown was causing errors
   - Solution: Replaced MerchantAutocomplete with plain Input for description

✅ 21. Added merchant and transfer information to transaction table display:
   - Shows merchant name if available
   - For transfers, shows "From Account → To Account" format
   - Added helper functions: getMerchantName, getAccountName, getTransactionDisplay
   - Transfer icon shows ArrowRightLeft in blue color
   - Reduced vertical space: p-4→p-2, space-y-3→space-y-2, removed type badge
   - Transactions now take up ~50% less vertical space

✅ 22. Fixed transaction creation 500 error - merchantId not handled:
   - Root cause: merchantId field added to schema/form but not extracted in API endpoints
   - POST /api/transactions now extracts merchantId from request body
   - PUT /api/transactions/[id] now supports merchantId updates
   - Removed old auto-merchant creation logic (conflicted with new MerchantSelector)
   - Now only tracks merchant usage when merchantId is explicitly provided
   - Updated validation to check for merchantId in update checks

✅ 23. Fixed 500 error on GET /api/transactions - better-sqlite3 bindings issue:
   - Root cause: Native bindings for better-sqlite3 weren't built
   - Solution: Cleaned .next directory and reinstalled dependencies with pnpm
   - pnpm install --force triggered proper build of better-sqlite3 native bindings
   - API now responds with {"error":"Unauthorized"} (expected Clerk auth error)
   - Transactions page should now load properly when authenticated

✅ 24. Fixed 500 error on GET /api/transactions - missing merchant_id column:
   - Root cause: Database migration 0005_add_merchant_id.sql wasn't applied to sqlite.db
   - Error: SqliteError: no such column: "merchant_id"
   - Solution: Created migration script to apply pending migrations manually
   - Applied migration: 0005_add_merchant_id (added merchant_id column and index)
   - API now returns proper Unauthorized error (authentication working)
   - RecentTransactions widget should now load when user is authenticated

✅ 25. Fixed recent transactions not showing merchant information:
   - Root cause: RecentTransactions component wasn't fetching or displaying merchant data
   - Missing: merchantId in Transaction interface, merchants/accounts state, helper functions
   - Solution:
     - Added merchantId, transferId to Transaction interface
     - Added Merchant and Account interfaces
     - Added merchants and accounts state
     - Fetch merchants and accounts data in useEffect
     - Added getMerchantName, getAccountName, getTransactionDisplay helper functions
     - Updated transaction display to show merchant name instead of just description
     - Updated repeat transaction logic to include merchantId
   - RecentTransactions widget now shows merchant names for transactions with merchants
   - Falls back to description if merchant not available
   - Handles transfers by showing "FromAccount → ToAccount" format

✅ 26. Fixed transaction page params Promise error:
   - Error: "A param property was accessed directly with `params.id`. `params` is a Promise..."
   - Root cause: Next.js 16 made params a Promise in dynamic routes
   - Solution:
     - Changed params interface type from object to Promise<{id: string}>
     - Imported React
     - Used React.use(params) to unwrap the Promise
     - Updated transactionId prop to use resolvedParams.id
   - Transaction details page now loads without errors

✅ 27. Fixed household page showing owner with no name:
   - Root cause: When creating household and when accepting invitations, userName wasn't being fetched from Clerk
   - Solution:
     - Imported clerkClient from '@clerk/nextjs/server'
     - In /api/households/route.ts POST: Fetch user from Clerk, extract firstName+lastName or firstName or username
     - In /api/invitations/accept/route.ts POST: Same approach for invited members
     - Now passes proper userName to householdMembers when creating records
   - Household members now display with their full names instead of blank

✅ 28. Fixed TransactionDetails component bgColor undefined error:
   - Error: "Cannot read properties of undefined (reading 'bgColor')" at line 159
   - Root cause: Transaction type was changed to 'transfer' but typeConfig and interface still referenced 'transfer_in'/'transfer_out'
   - Solution:
     - Updated Transaction interface type to include 'transfer' alongside 'transfer_in'/'transfer_out'
     - Added 'transfer' entry to typeConfig object
     - Added fallback to typeConfig.expense if type not found: `typeConfig[transaction.type as keyof typeof typeConfig] || typeConfig.expense`
     - Updated sign calculation to handle 'transfer' type
   - Transaction details page now loads without errors for all transaction types

✅ 29. Fixed tax dashboard and sales tax pages throwing errors with no data:
   - Root cause: Pages tried to render charts and tables with empty data arrays
   - Solution for Tax Dashboard:
     - Added hasData check (data.summary.byCategory.length > 0)
     - Added hasDeductions check for filtering tax-deductible items
     - Wrapped all content sections (metrics, charts, tables, tips) with conditional rendering
     - Added friendly empty state card with FileText icon
     - Shows helpful message: "No Tax Data Available" with instructions
   - Solution for Sales Tax Dashboard:
     - Added hasData check (data.quarters.length > 0)
     - Wrapped all content sections (metrics, chart, filing status, deadlines, tips) with conditional rendering
     - Added empty state card with DollarSign icon
     - Shows helpful message with step-by-step setup instructions
   - Both pages now gracefully handle empty data without errors
   - Year selector still available to check other years
   - Updated files: app/dashboard/tax/page.tsx, app/dashboard/sales-tax/page.tsx

✅ 30. Updated transaction display layout to show merchant, description, and account:
   - Root cause: Transaction list showed only merchant OR description, not both
   - Solution:
     - Refactored getTransactionDisplay() to return object with merchant and description separately
     - New layout structure:
       * Merchant name (bold, white, top line) - if merchant exists
       * Description (gray text below merchant, or main text if no merchant)
       * Date and split indicator (gray text)
       * Amount (right side, green for income, white for expenses)
       * Account name (below amount, gray text with 100px max width)
     - Transfer transactions show "FromAccount → ToAccount" as description
     - When no merchant: description appears as bold main text
     - When merchant exists: merchant bold on top, description gray below
   - Updated file: app/dashboard/transactions/page.tsx
   - New display provides better context with both merchant and description visible

✅ 31. Delete transactions functionality - Already implemented:
   - Feature request: "There should be a way to delete transactions"
   - Status: Already fully working
   - Location: Transaction details page at /dashboard/transactions/[id]
   - UI Features:
     - Delete button with Trash2 icon in top right corner
     - Red destructive button styling
     - Confirmation dialog: "Are you sure you want to delete this transaction? This action cannot be undone."
     - Loading state ("Deleting...") while processing
     - Success toast notification on completion
     - Auto-redirects back to transactions list after deletion
   - API Features:
     - DELETE endpoint at /api/transactions/[id]/route.ts (lines 236-327)
     - Verifies user authentication and transaction ownership
     - Automatically deletes associated transaction splits
     - Reverses balance changes on the account (using Decimal.js)
     - Proper error handling and logging
   - Files: components/transactions/transaction-details.tsx, app/api/transactions/[id]/route.ts

✅ 32. Removed transfers page and added account-based transaction filtering:
   - Part 1: Remove transfers page
     - Removed "Transfers" link from sidebar navigation (Financial section)
     - Removed ArrowRightLeft icon import (no longer used)
     - Transfers can now only be created via transaction form (type: "Transfer")
   - Part 2: Account-based transaction filtering
     - Added "View Transactions" button to AccountCard with ArrowRight icon
     - Button links to `/dashboard/transactions?accountId={accountId}`
     - Enhanced transactions page to accept accountId URL parameter
     - Auto-filters transactions by account when accountId is present in URL
     - Updated page header to show account name when filtered
       * "Account Name Transactions" instead of just "Transactions"
       * Subtitle shows "X transactions for this account"
     - Uses useSearchParams hook for URL parameter handling
     - Automatic search trigger when account filter is detected
   - Files updated:
     - components/accounts/account-card.tsx (added View Transactions button)
     - components/navigation/sidebar.tsx (removed Transfers link)
     - app/dashboard/transactions/page.tsx (added URL parameter handling and auto-filtering)
   - User experience:
     - Click account card → immediately see all transactions for that account
     - Transfer creation handled through standard transaction form
     - Cleaner navigation with one less menu item

✅ 33. Updated transaction type filters to use unified transfer type:
   - Root cause: Advanced search still showed "Transfer In" and "Transfer Out" filters
   - Solution:
     - Updated transactionTypes array in advanced-search.tsx
     - Replaced two separate transfer types with single "Transfer" option
     - Old: transfer_in (Transfer In), transfer_out (Transfer Out)
     - New: transfer (Transfer)
     - Matches the unified transfer type system implemented in bug #32
   - File updated: components/transactions/advanced-search.tsx (lines 75-79)
   - Result: Search filters now correctly align with current transaction type system

✅ 34. Fixed bills API 500 Internal Server Error:
   - Root cause: Invalid SQL query in GET /api/bills endpoint
   - Issue: Query was trying to select `upcomingInstance: billInstances` but billInstances was never joined to the query
   - This caused a SQL error when the query executed
   - Solution:
     - Removed `upcomingInstance: billInstances` from all three select statements (lines 31, 45, 59)
     - Upcoming instances are already fetched separately with a proper query (lines 79-98)
     - Query now only selects: bill, category (leftJoin), account (leftJoin)
   - Files updated: app/api/bills/route.ts
   - Result: Bills page now loads successfully without errors
   - Also fixes: Merchant deletion error (was same bills API error)

✅ 35. Added bill details page with delete functionality:
   - Root cause: Bills had no way to view details or delete them (unlike transactions)
   - Solution:
     - Created BillDetails component (components/bills/bill-details.tsx)
       * Displays full bill information (name, amount, due date, category, account, notes)
       * Shows overdue, upcoming, and paid bill instances
       * Includes Edit and Delete buttons with confirmation
       * Auto-redirects to bills list after deletion
     - Created bill details page route (app/dashboard/bills/[id]/page.tsx)
     - Created bill edit page route (app/dashboard/bills/edit/[id]/page.tsx)
       * Fetches existing bill data and populates form
       * Uses same BillForm component as create page
       * Updates bill via PUT /api/bills/[id]
     - Updated bills list page (app/dashboard/bills/page.tsx)
       * Made all BillItem components clickable links to details page
       * Added cursor-pointer styling for better UX
   - DELETE API endpoint already existed at /api/bills/[id]/route.ts
     * Deletes bill and all associated bill instances
     * Includes authentication and ownership verification
   - Files created:
     * components/bills/bill-details.tsx
     * app/dashboard/bills/[id]/page.tsx
     * app/dashboard/bills/edit/[id]/page.tsx
   - Files updated:
     * app/dashboard/bills/page.tsx
   - Result: Bills now have full details view with edit and delete functionality

✅ 36. Fixed household member names not displaying (bug 27 reopened):
   - Root cause: Existing household members in database had null/empty userName field
   - Previous fix (bug 27) only addressed new members created after the fix
   - Old data created before the fix still had empty userName values
   - Additional issue: clerkClient usage was incorrect for newer Clerk SDK
   - Solution:
     - Enhanced GET /api/households/[householdId]/members/route.ts
       * Added automatic backfill logic when fetching members
       * Checks if userName is missing or empty for each member
       * Fetches user info from Clerk API (firstName, lastName, username)
       * Updates database with userName for future requests
       * Returns updated member list with names populated
     - Created manual backfill endpoint at /api/households/backfill-names/route.ts
       * Can be called to bulk update all members at once
       * Useful for one-time migration if needed
     - Fixed clerkClient usage across all files
       * Changed from `clerkClient.users.getUser()` to `(await clerkClient()).users.getUser()`
       * clerkClient is a function in newer SDK, must be called first
   - Files updated:
     * app/api/households/[householdId]/members/route.ts (automatic backfill + clerkClient fix)
     * app/api/households/route.ts (clerkClient fix)
     * app/api/invitations/accept/route.ts (clerkClient fix)
   - Files created:
     * app/api/households/backfill-names/route.ts (manual backfill)
   - Result: Household page now automatically fixes missing names when loaded
   - Names display properly as "FirstName LastName" instead of blank

✅ 37. Updated RecentTransactions to match transactions page display:
   - Root cause: Recent transactions widget showed different layout than transactions page
   - Missing merchant/description separation, account name, split indicator
   - Solution:
     - Updated getTransactionDisplay() to return object with {merchant, description} instead of string
     - Added isSplit field to Transaction interface
     - Updated transaction item layout to match transactions page exactly:
       * Merchant name on top (bold) if exists
       * Description below merchant (gray) or standalone (bold) if no merchant
       * Date and split indicator in gray
       * Amount on right (green for income, white for expense)
       * Account name below amount (gray, max 100px width)
       * Copy/repeat button with proper sizing (h-7 w-7)
     - Updated getTransactionIcon to handle unified 'transfer' type
     - Reduced card padding from p-4 to p-2 to match transactions page
     - Reduced spacing from space-y-3 to space-y-2
     - Made entire card clickable as Link to transaction details
   - Files updated:
     * components/dashboard/recent-transactions.tsx
   - Result: Recent transactions now display identically to transactions page
   - Consistent user experience across dashboard and transactions page

✅ 38. Fixed duplicate/repeat transaction error in RecentTransactions (FIRST FIX):
   - Error: "Cannot read properties of undefined (reading 'toFixed')" at line 235
   - Root cause: POST /api/transactions returns {id, message, appliedCategoryId, ...} not full transaction object
   - handleRepeatTransaction was adding incomplete object to state
   - Missing fields: amount, description, type, date, etc.
   - Solution:
     - Updated handleRepeatTransaction to construct full Transaction object from API response + original data
     - Maps result.id to new transaction id
     - Copies all other fields from original transaction (amount, description, type, etc.)
     - Uses result.appliedCategoryId if rules applied a category
     - Sets date to today's date
     - Sets isSplit to false for new transactions
   - Files updated:
     * components/dashboard/recent-transactions.tsx
   - Result: Duplicate transaction button now works without errors
   - New transaction appears correctly in list with all fields populated

✅ 39. Fixed duplicate/repeat transaction error AGAIN (bug 7 reopened - Part 1):
   - Error: "Cannot read properties of undefined (reading 'toFixed')" still occurring after bug 38 fix
   - Transaction was created successfully in DB but error threw in UI
   - After refresh, duplicated transaction appeared correctly
   - Root cause: Type mismatch between API response data format and manually constructed newTransaction object
   - The manual state manipulation approach was fragile and prone to type inconsistencies
   - Solution:
     - Added type safety for amount field: checks if number, otherwise parses float with fallback to 0
     - Changed approach from manual state manipulation to refetching transactions after duplicate
     - Now calls GET /api/transactions?limit=5 after successful POST
     - This ensures UI always has same data structure as initial load
     - Matches the "refresh" behavior that was working correctly
   - Files updated:
     * components/dashboard/recent-transactions.tsx (lines 104, 115-119)
   - Result: Duplicate button now works reliably without errors on dashboard
   - UI always reflects true database state with proper data types

✅ 39b. Fixed duplicate/repeat transaction error on transactions page (bug 7 reopened - Part 2):
   - Error: "Cannot read properties of undefined (reading 'toFixed')" at app/dashboard/transactions/page.tsx:402
   - Same issue as Part 1 but on the transactions page instead of dashboard
   - Root cause: Transactions page was also using manual state manipulation (line 208-209)
   - Code: `const newTransaction = await response.json(); setTransactions([newTransaction, ...transactions]);`
   - API returns {id, message, appliedCategoryId} not full transaction object
   - Solution:
     - Changed to refetch transactions after successful POST
     - Checks if currentFilters exists to determine search mode vs. initial mode
     - If in search mode: calls performSearch(currentFilters, paginationOffset)
     - If in initial mode: fetches from /api/transactions?limit=100
     - Same pattern as dashboard fix - refetch instead of manual state manipulation
     - Ensures data consistency across both pages
   - Files updated:
     * app/dashboard/transactions/page.tsx (lines 208-222)
   - Result: Duplicate button works on both dashboard AND transactions page
   - Works correctly in both search mode and regular view mode
   - No more toFixed errors anywhere in the app

✅ 40. Fixed transaction deletion failing for unified transfer type:
   - Error: "Failed to delete transaction" when trying to delete any transaction
   - Root cause: DELETE endpoint checking for 'transfer_out' but unified transfer type is now just 'transfer'
   - This caused balance reversal logic to fail (lines 294, 178, 191 in route.ts)
   - When deleting a transfer, the condition `transaction.type === 'expense' || transaction.type === 'transfer_out'` didn't match 'transfer'
   - Solution:
     - Updated DELETE endpoint balance reversal to include 'transfer' type (line 294)
     - Updated PUT endpoint balance reversal to include 'transfer' type (lines 178, 191)
     - Added clarifying comments for transfer handling
   - Files updated:
     * app/api/transactions/[id]/route.ts (lines 178, 191, 294)
   - Result: Transaction deletion now works for all transaction types including unified transfers
   - Balance reversal correctly handles expenses, transfers, and income

✅ 41. Created Rules Management Page:
   - Issue: Sidebar had link to /dashboard/rules but page didn't exist (404)
   - API endpoints already existed (/api/rules) and components were built (RuleBuilder, BulkApplyRules)
   - Created comprehensive rules page at /dashboard/rules/page.tsx
   - Features implemented:
     - List all rules with priority, status, match count, last used date
     - Create new rules (opens RuleBuilder)
     - Edit existing rules
     - Delete rules with confirmation
     - Toggle rules active/inactive
     - Change rule priority (move up/down)
     - Bulk apply rules to existing transactions
     - Empty state for first-time users
     - Info card explaining how rules work
     - Clean dark mode design matching app style
   - Files created:
     * app/dashboard/rules/page.tsx (full page implementation)
   - Result: Rules page is now fully functional and accessible from sidebar
   - Users can create, edit, delete, and manage auto-categorization rules

✅ 42. Fixed merchant spending charts tracking description instead of merchant:
   - Issue: Reports page merchant analysis was grouping by transaction description instead of actual merchants
   - Root cause: groupByMerchant function in lib/reports/report-utils.ts was using txn.description (line 114)
   - TransactionData interface didn't include merchantId field
   - merchant-analysis API route wasn't fetching merchant names
   - Solution:
     - Added merchantId field to TransactionData interface
     - Updated groupByMerchant to use merchantId when available, falls back to description
     - Updated merchant-analysis route to fetch merchant records from database
     - Created merchantMap to convert merchantId to merchant name
     - Fixed summary statistics to use merchantId instead of description (lines 75, 79)
   - Files updated:
     * lib/reports/report-utils.ts (added merchantId to interface, updated groupByMerchant function)
     * app/api/reports/merchant-analysis/route.ts (added merchant name lookup, fixed summary)
   - Result: Merchant spending charts now correctly track and display actual merchant names
   - Transactions with merchants show proper merchant names in reports
   - Transactions without merchants fall back to description (backward compatible)

✅ 43. Fixed account name being cut off in transaction entry:
   - Issue: Account names were truncated without proper text ellipsis in dropdowns
   - Occurred in both AccountSelector component and transfer "To Account" selector
   - Root cause: Account name span didn't have truncate classes or proper flex behavior
   - Long account names would overflow and get cut off awkwardly
   - Solution:
     - Added w-full to flex container for proper width distribution
     - Made DollarSign icon flex-shrink-0 to prevent icon from shrinking
     - Added flex-1 truncate to account name span for proper text truncation with ellipsis
     - Made balance span flex-shrink-0 to keep it fully visible
     - Applied same fix to both AccountSelector and "To Account" in transaction form
   - Files updated:
     * components/transactions/account-selector.tsx (lines 71-76)
     * components/transactions/transaction-form.tsx (lines 649-653)
   - Result: Account names now properly truncate with ellipsis (...) when too long
   - Icon and balance remain fully visible while name gracefully truncates
   - Better UX for users with long account names

✅ 44. Implemented account update functionality:
   - Issue: Update Account button showed error "Account editing not yet implemented"
   - Root cause: PUT endpoint didn't exist in app/api/accounts/[id]/route.ts
   - Frontend had TODO comment (line 59-62) that returned early with error message
   - Solution:
     - Created PUT endpoint in app/api/accounts/[id]/route.ts
     - Accepts: name, type, bankName, accountNumberLast4, currentBalance, creditLimit, color, icon, isBusinessAccount
     - Validates user authentication and account ownership
     - Validates required fields (name and type)
     - Preserves existing values for fields not provided in update
     - Updates account with new values and sets updatedAt timestamp
     - Updated accounts page handleSubmit to call PUT when selectedAccount exists
     - Changed method from always POST to conditional PUT/POST based on edit mode
     - Updated all toast messages to reflect create vs update appropriately
     - Updated console error messages for better debugging
   - Files updated:
     * app/api/accounts/[id]/route.ts (added PUT endpoint, lines 8-88)
     * app/dashboard/accounts/page.tsx (implemented update logic, lines 54-98)
   - Result: Update Account button now fully functional
   - Users can edit account name, type, bank info, balances, and business account status
   - Proper success/error messages for both create and update operations

✅ 45. Added New Transaction button to transactions page:
   - Issue: Transactions page had no quick way to create a new transaction
   - Users had to go back to dashboard to add transactions
   - Solution:
     - Added Plus icon to lucide-react imports
     - Created "New Transaction" button in toolbar section (next to Import CSV)
     - Button uses emerald styling to match app theme (bg-emerald-500)
     - Links to /dashboard/transactions/new page
     - Button includes Plus icon for visual clarity
     - Grouped both buttons (New Transaction + Import CSV) in flex container
   - Files updated:
     * app/dashboard/transactions/page.tsx (lines 4, 331-350)
   - Result: Users can now quickly create transactions from the transactions page
   - Better UX - one less click to add a transaction
   - Consistent with other pages that have create buttons

✅ 46. Fixed edit transaction button params Promise error:
  - Error: "A param property was accessed directly with `params.id`. `params` is a Promise..."
  - Root cause: Next.js 16 made params a Promise in dynamic routes (same as bug #26)
  - Edit transaction page was accessing params.id directly without unwrapping
  - Solution:
    - Imported React
    - Changed params interface type from object to Promise<{id: string}>
    - Used React.use(params) to unwrap the Promise
    - Updated all references to params.id to use resolvedParams.id
    - Applied to 3 locations: handleEditSuccess callback, Link href, TransactionForm prop
  - Files updated:
    * app/dashboard/transactions/[id]/edit/page.tsx (lines 3, 11-14, 19, 22, 29, 39)
  - Result: Edit transaction button now works without errors
  - Same fix pattern as bug #26 for transaction details page

✅ 47. Fixed unified transfer type implementation and display (bugs 2, 3, 4, 5):
  - Root cause: Transfer form sends unified 'transfer' type with toAccountId, but API wasn't handling it
  - Multiple issues fixed:
    * API wasn't extracting toAccountId from request body
    * transferId field wasn't being populated in database
    * Destination account showed as "Unknown" because transferId was null
    * Balance updates weren't working for both accounts in transfer
    * Display logic showed incorrect +/- signs for transfers
    * Transfers only showed in "from" account, not "to" account
    * Money was added to same account instead of transferring between accounts
  - Solution Part 1 - API Updates (app/api/transactions/route.ts):
    * Added toAccountId extraction from request body
    * Added validation for toAccountId when type is 'transfer'
    * Added toAccount validation to ensure it exists and belongs to user
    * Updated categorization rules to skip 'transfer' type
    * Set transferId field when creating transaction
    * Updated balance logic to include 'transfer' type (subtract from source account)
    * Added destination account balance update (add to destination account)
  - Solution Part 2 - Display Updates:
    * RecentTransactions (components/dashboard/recent-transactions.tsx):
      - Transfers now show in blue color
      - No +/- sign for transfers in general view
    * Transactions Page (app/dashboard/transactions/page.tsx):
      - Transfers show in blue color
      - No +/- sign for transfers in general view
      - Account-aware display: when filtered by account, shows - if money leaving, + if money arriving
    * Transaction Details (components/transactions/transaction-details.tsx):
      - Added transferId to Transaction interface
      - Added Account interface and accounts state
      - Fetch accounts data to look up names
      - Added getAccountName helper function
      - Added "Transfer Account Information" section showing "From Account" and "To Account"
  - Files updated:
    * app/api/transactions/route.ts (lines 35, 49-55, 76-97, 124, 161, 175, 188-201)
    * components/dashboard/recent-transactions.tsx (lines 245-258)
    * app/dashboard/transactions/page.tsx (lines 417-436)
    * components/transactions/transaction-details.tsx (lines 16, 28-31, 48, 53-80, 126-130, 204-222)
  - Result: Transfers now work correctly end-to-end
  - Both accounts update properly (bug #5 fixed)
  - Second account name displays correctly (bug #2 fixed)
  - Display logic is context-aware (bug #2 fixed)
  - Transaction details show full transfer information (bug #3 fixed)
  - Transfers show when filtering by either account (bug #4 fixed)

✅ 48. Connected dashboard quick view cards to real data:
  - Root cause: Dashboard cards showed hardcoded values ($0.00) instead of fetching data
  - Solution:
    * Added state for totalBalance, monthlySpending, and loading
    * Added interfaces for Account and Transaction
    * Added useEffect to fetch dashboard data on component mount
    * Fetches all accounts and calculates total balance using Decimal.js
    * Fetches transactions and filters for current month expenses
    * Calculates monthly spending total
    * Updates Total Balance card to display actual sum of all account balances
    * Updates Monthly Spending card to display actual expense total for current month
    * Added loading state to show "..." while fetching data
  - Files updated:
    * app/dashboard/page.tsx (lines 3, 11, 13-24, 28-30, 52-97, 111-113, 127-129)
  - Result: Dashboard cards now show real-time data
  - Total Balance reflects sum of all account balances
  - Monthly Spending shows current month's expenses

✅ 49. Enhanced split transaction functionality:
  - Root cause: Split transactions needed better UX and automatic calculation
  - Improvements implemented:
    * Auto-populate 2 splits when clicking "Add Splits" button
    * Each split starts with half of the transaction amount
    * Main transaction description automatically copied to both splits
    * Added description input field for each split
    * Users can now have unique descriptions per split
    * Bidirectional auto-calculation for remaining amount
    * When editing any split except the last, the last split auto-adjusts to remainder
    * When editing the last split, the second-to-last adjusts (if 3+ splits)
    * Works with any number of splits (2, 3, 4, etc.)
    * Auto-calculation only applies to fixed amount mode (not percentage)
  - Files updated:
    * components/transactions/transaction-form.tsx (lines 749-777)
      - Updated button onClick to create 2 initial splits
      - Copies transaction description to each split
      - Calculates half amount for each split
    * components/transactions/split-builder.tsx (lines 95-149, 243-264)
      - Added handleUpdateSplitDescription function
      - Enhanced handleUpdateSplitAmount with bidirectional calculation logic
      - Added description Input field to each split card
  - Result: Much improved split transaction UX
  - Splits start pre-populated with sensible defaults
  - Auto-calculation eliminates manual math
  - Each split can have its own description for better tracking

✅ 50. Fixed transfers not showing description in transaction view:
  - Root cause: getTransactionDisplay function replaced description with account names
  - For transfers, function returned account names as description and null for merchant
  - This meant the actual transaction.description was never displayed
  - Solution:
    * Changed transfer display logic to use account names as "merchant" field
    * Transaction description now properly displayed in "description" field
    * Updated in both RecentTransactions and transactions page
  - Display now shows:
    * Top line (bold): "FromAccount → ToAccount"
    * Second line (gray): Actual transaction description
  - Files updated:
    * components/dashboard/recent-transactions.tsx (lines 147-149)
    * app/dashboard/transactions/page.tsx (lines 279-281)
  - Result: Transfers now display both account transfer info AND description
  - Consistent with how merchant transactions display (merchant on top, description below)

✅ 51. Implemented 2-transaction transfer model:
  - Root cause: Transfers used single transaction with unified 'transfer' type
  - Requirements: Backend should create 2 transactions (transfer_out + transfer_in)
  - Main view should show single entry, account-filtered view should show relevant side
  - Solution Part 1 - Database Migration:
    * Created migration 0006_convert_transfers_to_paired_model.sql
    * Converted existing 'transfer' transactions to transfer_out/transfer_in pairs
    * transfer_out: accountId = source, transferId = destination account ID
    * transfer_in: accountId = destination, transferId = transfer_out transaction ID
    * Applied migration successfully, verified linking in database
  - Solution Part 2 - API Updates (app/api/transactions/route.ts):
    * POST endpoint now creates TWO transactions when type='transfer'
    * Creates transfer_out (source account, subtracts amount)
    * Creates transfer_in (destination account, adds amount)
    * Links via transferId field (transfer_in.transferId → transfer_out.id)
    * Updates both account balances correctly
    * Tracks transfer_pair usage in analytics
  - Solution Part 3 - GET Endpoint Filtering:
    * Added accountId parameter detection
    * Main view (no accountId): Filters out transfer_in to show only transfer_out (avoids duplicates)
    * Account-filtered view: Returns both transfer_in and transfer_out
    * This achieves the requirement of "one entry in main, both sides when filtered"
  - Solution Part 4 - DELETE Endpoint:
    * Updated to handle transfer pairs
    * Deletes both transfer_out and transfer_in transactions
    * Reverses balances on both accounts
    * Handles deletion from either side of the pair
  - Solution Part 5 - Display Logic:
    * Updated getTransactionDisplay in transactions page and RecentTransactions
    * transfer_out: Shows "SourceAccount → DestAccount"
    * transfer_in: Looks up paired transfer_out, shows "SourceAccount → DestAccount"
    * Maintains consistent display across both components
  - Files updated:
    * drizzle/0006_convert_transfers_to_paired_model.sql (migration)
    * app/api/transactions/route.ts (POST: lines 146-311, GET: lines 576-613)
    * app/api/transactions/[id]/route.ts (DELETE: lines 285-441)
    * app/dashboard/transactions/page.tsx (display: lines 277-306)
    * components/dashboard/recent-transactions.tsx (display: lines 145-174)
  - Result: Transfers now use proper 2-transaction model
  - Main view shows single entry per transfer (transfer_out only)
  - Account-filtered view shows relevant transaction side
  - Both sides properly linked via transferId
  - Deletion and balance updates work correctly for both sides

✅ 52. Fixed CSV import Select.Item empty value error:
  - Error: "A <Select.Item /> must have a value prop that is not an empty string"
  - Root cause: TRANSFORMS array had first item with empty string value: `{ value: '', label: 'None' }`
  - Select component doesn't allow empty string values (reserves it for clearing/placeholder)
  - Solution:
    * Changed empty string to 'none' in TRANSFORMS array (column-mapper.tsx line 33)
    * Updated ColumnMapping type to include 'none' in transform union type (lib/csv-import.ts line 19)
    * Added 'none' case to applyStringTransform function (returns value unchanged)
    * Default case still trims for backward compatibility
  - Files updated:
    * components/csv-import/column-mapper.tsx (line 33: '' → 'none')
    * lib/csv-import.ts (line 19: added 'none' to type, lines 346-347: added none case)
  - Result: CSV import no longer throws error when selecting transform options
  - "None" transform option now properly returns value unchanged

✅ 53. Enhanced split transaction UI with prepopulation and reorganization:
  - Requirements:
    * Each split should have a category field prepopulated with main transaction's category
    * Add split section should be a single button (not a form)
    * Button should be positioned under existing splits
    * New splits should be prepopulated with sensible defaults
  - Solution Part 1 - SplitBuilder Props:
    * Added mainCategory prop to receive main transaction's category
    * Added transactionDescription prop for prepopulation
    * Updated SplitBuilderProps interface (lines 32-39)
  - Solution Part 2 - Simplified Add Split Logic:
    * Removed newSplitCategory and newSplitAmount state (no longer need form)
    * Updated handleAddSplit to auto-calculate remaining amount
    * Prepopulates new split with mainCategory
    * Prepopulates description with transactionDescription
    * Uses getRemainingForNewSplit to auto-fill amount
  - Solution Part 3 - UI Reorganization:
    * Removed "Add New Split" form card (lines 202-241 deleted)
    * Moved splits list to appear first (after split type toggle)
    * Added CategorySelector to each split card for editing
    * Added handleUpdateSplitCategory function to update split categories
    * Placed simple "Add Split" button below splits list
  - Solution Part 4 - Enhanced Split Cards:
    * Each split now shows CategorySelector at top
    * Category prepopulated from main transaction
    * Users can change category for each split independently
    * Amount and description fields remain editable
  - Solution Part 5 - Transaction Form Integration:
    * Updated transaction-form.tsx to pass mainCategory prop
    * Passes formData.categoryId to SplitBuilder
    * Passes formData.description to SplitBuilder
  - Files updated:
    * components/transactions/split-builder.tsx (lines 32-39, 41-48, 65-81, 159-169, 165-276)
    * components/transactions/transaction-form.tsx (lines 797-798)
  - Result: Improved split transaction workflow
  - Single-click to add new split with smart defaults
  - Each split has its own category selector
  - Category prepopulated from main transaction
  - Description and amount auto-calculated
  - Cleaner UI with button below splits (not a big form on top)

✅ 54. CSV import support for separate withdrawal/deposit columns:
  - Added 'withdrawal' and 'deposit' as new appField types
  - Updated ColumnMapping interface to include new field types
  - Enhanced auto-detection patterns:
    * Withdrawal: /withdrawal|withdraw|debit|paid.*out|spent|expense/i
    * Deposit: /deposit|credit|received|income/i
    * Made generic 'amount' pattern more specific to avoid false matches
  - Updated applyMappings function to handle dual-column CSVs:
    * Withdrawal values → expense transactions (auto-typed)
    * Deposit values → income transactions (auto-typed)
    * Empty values properly skipped (common in dual-column format)
    * Amounts always converted to positive with .abs()
  - Updated UI with new field options:
    * "Withdrawal (Expense)" option in field selector
    * "Deposit (Income)" option in field selector
  - Files updated:
    * lib/csv-import.ts (interface, auto-detection, mapping logic)
    * components/csv-import/column-mapper.tsx (UI field options)
  - Result: Bank exports with separate debit/credit columns now fully supported

✅ 55. CSV import modal responsiveness issues:
  - Root cause: Modal too large, buttons inside scrollable area, content overflowing viewport
  - Solution Part 1 - Modal Container (csv-import-modal.tsx:231-243):
    * Changed from fixed width to responsive: max-w-[95vw] sm:max-w-2xl
    * Responsive height: max-h-[95vh] sm:max-h-[90vh]
    * Added flex flex-col with p-0 for layout control
    * Fixed header with shrink-0 and proper padding
  - Solution Part 2 - Sticky Footer (csv-import-modal.tsx:389-434):
    * Moved all navigation buttons out of scrollable area
    * Created sticky footer at bottom with border-t and bg-[#0a0a0a]
    * Context-aware buttons based on step:
      - Upload: Cancel + Next
      - Settings: Back + Next
      - Mapping: Back + Preview (with loading state)
      - Complete: Done
      - Preview: Uses its own buttons from ImportPreview component
  - Solution Part 3 - Scrollable Content (csv-import-modal.tsx:243):
    * Content area with overflow-y-auto flex-1 px-6 py-4
    * Scrolls independently between fixed header and sticky footer
  - Solution Part 4 - Compact Column Mapper (column-mapper.tsx):
    * Reduced all text sizes (text-sm → text-xs)
    * Smaller padding and heights (p-4 → p-2, h-8 inputs)
    * Responsive grid: grid-cols-1 sm:grid-cols-3 (stacks on mobile)
    * Unmapped columns limited to max-h-32 overflow-y-auto
    * Added borders and truncation for better visual separation
    * Uses ~60% less vertical space
  - Files updated:
    * components/csv-import/csv-import-modal.tsx
    * components/csv-import/column-mapper.tsx
  - Result: Modal fully responsive on all devices, buttons always accessible

✅ 56. Preview button not responding and modal responsiveness:
  - Issue: Preview button was inside scrollable content area, getting cut off on mobile
  - Solution: Restructured modal with sticky footer outside scrollable area
  - All navigation buttons now in fixed footer, always visible
  - Modal width: 95vw on mobile, max-w-2xl on desktop
  - Result: Preview button and all other buttons always accessible

✅ 57. Full site responsive design and horizontal overflow prevention:
  - Root cause: Content not constrained to viewport, causing horizontal scrolling
  - Solution Part 1 - Global Overflow Prevention (app/layout.tsx):
    * Added overflow-x-hidden to body class
    * Added inline styles: maxWidth: '100vw', position: 'relative'
    * Wrapped children in div with w-full max-w-full overflow-x-hidden
  - Solution Part 2 - Global CSS Rules (app/globals.css:91-154):
    * HTML/body: overflow-x-hidden, width: 100%, max-width: 100vw
    * All .min-h-screen containers: overflow-x-hidden, max-width: 100vw
    * Created utility classes:
      - .table-responsive: Auto-scrolling tables with touch support
      - .truncate-safe: Prevents text overflow with ellipsis
      - .responsive-card: Cards that stay within viewport
      - Button/link max-width constraints
  - Solution Part 3 - Dashboard Layout (components/navigation/dashboard-layout.tsx):
    * Added overflow-x-hidden w-full max-w-full to root container
    * Added w-full max-w-full min-w-0 overflow-x-hidden to content wrapper
    * Added w-full max-w-full overflow-x-hidden to main element
  - Solution Part 4 - Sidebar (components/navigation/sidebar.tsx):
    * Added overflow-x-hidden to prevent sidebar overflow
    * Added shrink-0 to maintain fixed width
  - Solution Part 5 - Mobile Nav (components/navigation/mobile-nav.tsx):
    * Root div: w-full max-w-full overflow-x-hidden
    * Header and all containers: w-full max-w-full constraints
  - Solution Part 6 - Chart Container (components/charts/chart-container.tsx):
    * Added overflow-hidden to Card wrapper
    * Added overflow-x-auto to CardContent and chart div
    * Charts can scroll internally but won't break page layout
  - Files updated:
    * app/layout.tsx
    * app/globals.css
    * components/navigation/dashboard-layout.tsx
    * components/navigation/sidebar.tsx
    * components/navigation/mobile-nav.tsx
    * components/charts/chart-container.tsx
  - Result: No horizontal scrolling on any device, all content fits viewport

✅ 58. Mobile nav appearing beside content instead of above:
  - Root cause: Layout used flex (row direction) making all items horizontal
  - Solution (components/navigation/dashboard-layout.tsx:16-30):
    * Changed root container to flex flex-col lg:flex-row
    * Mobile: Column direction (items stack vertically)
    * Desktop: Row direction (sidebar + content side-by-side)
    * Wrapped MobileNav + main content in flex flex-col container
    * MobileNav and content always stack vertically inside wrapper
  - Result: Mobile shows nav at top, content below; Desktop shows sidebar left, content right

✅ 59. Mobile navigation sections missing pages:
  - Root cause: Mobile nav outdated, missing recently added pages
  - Solution (components/navigation/mobile-nav.tsx:39-74):
    * Added missing pages:
      - Accounts page (was missing)
      - Merchants page (was missing)
      - Tax section (entire section was missing)
      - Sales Tax page (was missing)
    * Removed deprecated pages:
      - Transfers page (removed in bug #32)
    * Fixed isActive function to match sidebar logic (exact match for dashboard)
    * Updated icon imports (added Store, removed ArrowRightLeft)
  - Files updated: components/navigation/mobile-nav.tsx
  - Result: Mobile nav now has identical structure to desktop sidebar

✅ 60. Fixed CSV import preview button not responding:
 - Root cause 1: When step was 'preview' but previewData was not set, nothing was rendered
   * The sticky footer buttons were hidden (only shown when step !== 'preview')
   * ImportPreview has its own buttons, but wasn't rendering if previewData was falsy
 - Root cause 2: Node.js Buffer used in client-side code causing API call to fail
   * Buffer.from() is a Node.js API not available in browsers
   * This caused "Internal server error" when calling preview API
   * Error was: "Preview API error: {}" followed by "Internal server error"
 - Solution Part 1 - Added console logging for debugging:
   * Added console.log when sending preview request with mappings
   * Added console.log when preview data is received
   * Added console.error for API errors and general errors
   * Helps identify if API call fails silently
 - Solution Part 2 - Added Back button to ImportPreview:
   * Added onBack optional prop to ImportPreviewProps interface
   * Changed "Cancel" button to "Back to Mapping" button
   * Button calls onBack handler instead of window.history.back()
   * Modal passes () => setStep('mapping') as onBack handler
 - Solution Part 3 - Added empty state handling:
   * ImportPreview now shows empty state if staging.length === 0
   * Shows AlertCircle icon and helpful message
   * Modal shows fallback message if step is 'preview' but previewData is falsy
   * Fallback includes "Back to Mapping" button for recovery
 - Solution Part 4 - Fixed Buffer usage in client code (CRITICAL FIX #1):
   * Replaced Buffer.from(binaryString, 'binary').toString('base64') with btoa(binaryString)
   * btoa() is the native browser API for base64 encoding
   * Fixed in both handleProceedToPreview and handleConfirmImport functions
   * Changed from String.fromCharCode.apply() to manual loop for better browser compatibility
 - Solution Part 5 - Fixed FileReader usage in server code (CRITICAL FIX #2):
   * Root cause: API route was calling parseCSVFile() which uses FileReader
   * FileReader is a browser-only API and doesn't exist in Node.js server environment
   * This caused "Internal server error" when API tried to parse the CSV
   * Solution: Replaced File object + parseCSVFile with direct text parsing
   * Convert base64 → text with Buffer.from(fileBase64, 'base64').toString('utf-8')
   * Parse directly with PapaParse without FileReader
   * Build parsed object structure manually (headers, rows, totalRows)
   * Updated file.size reference to text.length
   * Removed parseCSVFile and autoDetectMappings imports (no longer needed)
 - Solution Part 6 - Fixed validation for withdrawal/deposit columns:
   * Root cause: Validation required 'amount' field but CSV had 'withdrawal' and 'deposit'
   * Bug #54 added support for separate withdrawal/deposit columns
   * But validation wasn't updated to accept them as valid alternatives
   * Solution: Updated validation logic to accept either:
     - Single 'amount' field, OR
     - At least one of 'withdrawal' or 'deposit' fields
   * Added comprehensive logging for debugging (base64 length, decoded text, line counts, row counts)
   * Made error handling smarter - only fails if errors AND no data parsed
   * Non-critical quote errors (malformed quotes on last row) are logged as warnings
 - Files updated:
   * components/csv-import/csv-import-modal.tsx (lines 119-126, 172-179, 125-127, 146-148, 151, 157, 366-400)
   * components/csv-import/import-preview.tsx (lines 26, 38, 132-193, 191-199)
   * app/api/csv-import/route.ts (lines 7-12, 76-170) - server-side parsing fix + validation fix
 - Result: CSV import preview now works correctly end-to-end
 - Client-side uses browser-compatible base64 encoding (btoa)
 - Server-side uses Node.js-compatible parsing (no FileReader)
 - Validation accepts both single-column (amount) and dual-column (withdrawal/deposit) formats
 - Comprehensive logging helps debug issues
 - Smart error handling doesn't fail on non-critical quote errors
 - Users can navigate back to mapping if preview fails
 - Better UX with helpful messages instead of blank screen

✅ 61. Fixed CSV import showing $0 amounts for withdrawal/deposit columns:
 - Root cause: Dual-column CSV format has both withdrawal AND deposit columns per row
   * Example: Withdrawal="82.21", Deposit="0.00" for expenses
   * Example: Withdrawal="0.00", Deposit="98.25" for income
   * Both columns were being processed sequentially
   * The second column (with "0.00") was overwriting the first column's valid amount
 - Solution: Only set amount if value is non-zero
   * Added !withdrawalAmount.isZero() check before setting amount
   * Added !depositAmount.isZero() check before setting amount
   * Now "0.00" values are skipped instead of overwriting the real amount
   * Each transaction keeps the non-zero value (either withdrawal OR deposit)
 - Files updated:
   * lib/csv-import.ts (lines 289-321) - Added zero-check for withdrawal/deposit
 - Result: CSV import now correctly shows amounts
   * $82.21 for withdrawal transactions (expenses)
   * $98.25 for deposit transactions (income)
   * No more $0.00 transactions from dual-column CSVs

✅ 62. Fixed CSV import button doing nothing (400 error):
 - Root cause: Mismatch between frontend and backend data formats
   * Frontend sends row numbers as strings: ['1', '2', '3', ...]
   * Backend was checking against staging record IDs (nanoid): 'BfUcRieZARAQKTD95NKL-'
   * Filter never found matches: recordIds.includes(r.id) always false
   * Empty array triggered 400 error: "No records to import"
 - Solution: Updated backend to filter by row numbers instead of IDs
   * Convert recordIds strings to integers: parseInt(id, 10)
   * Create Set for fast lookup: new Set(recordIds.map(...))
   * Filter by rowNumber: rowNumbersToImport.has(r.rowNumber)
   * Added logging to debug: importId, recordIds, staging count, import count
 - Files updated:
   * app/api/csv-import/[importId]/confirm/route.ts (lines 32-34, 60-72)
   * components/csv-import/csv-import-modal.tsx (lines 168-187) - Added logging
   * components/csv-import/import-preview.tsx (lines 206-218) - Added logging
 - Result: Import button now works correctly
   * Finds matching records by row number
   * Imports all selected transactions into database
   * Shows success message and completion screen

✅ 63. Added auto-refresh after CSV import success:
 - Enhancement: Transactions page should refresh after import completes
 - Solution:
   * Added optional onSuccess callback prop to CSVImportModal
   * handleClose() calls onSuccess when step === 'complete'
   * Transactions page passes onSuccess handler that:
     - Fetches latest transactions from API
     - Updates transactions state with new data
     - Shows success toast notification
   * Refresh happens automatically when user closes import success modal
 - Files updated:
   * components/csv-import/csv-import-modal.tsx (lines 34, 41, 241-244)
   * app/dashboard/transactions/page.tsx (lines 511-524)
 - Result: After successful import, transactions page auto-refreshes
   * User sees newly imported transactions immediately
   * No manual page refresh needed
   * Shows "Transactions refreshed" toast

pending


