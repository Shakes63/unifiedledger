---
description: Development guidelines, coding standards, and best practices for Unified Ledger
alwaysApply: true
---

# Development Guidelines

## Always Use pnpm
```bash
pnpm install       # Install dependencies
pnpm dev           # Start dev server
pnpm build         # Build for production
pnpm test          # Run tests
```

## Financial Calculations
**CRITICAL:** Always use `decimal.js` for money calculations to avoid floating-point errors.
```typescript
import Decimal from 'decimal.js';
const total = new Decimal(100.50).plus(new Decimal(25.25)); // ✓ Correct
const wrong = 100.50 + 25.25; // ✗ Never use this
```

## Design System & Theming
**Theming System:**
- 7 themes: Dark (Green, Pink, Blue, Turquoise), Light (Bubblegum, Turquoise, Blue)
- Dynamic theme switching with CSS variables
- Themes defined in `lib/themes/theme-config.ts`, applied via `applyTheme()`
- Preference saved to database

**Always Use Semantic Color Tokens (NOT hardcoded colors):**
- Background: `bg-background`, `bg-card`, `bg-elevated`
- Text: `text-foreground`, `text-muted-foreground`
- Borders: `border-border`
- Transactions: `text-[var(--color-income)]`, `text-[var(--color-expense)]`, `text-[var(--color-transfer)]`
- UI States: `bg-[var(--color-primary)]`, `bg-[var(--color-success)]`, `bg-[var(--color-warning)]`, `bg-[var(--color-error)]`

**Key CSS Variables:**
```
--color-background, --color-card, --color-elevated
--color-foreground, --color-muted-foreground
--color-border, --color-ring
--color-income, --color-expense, --color-transfer
--color-primary, --color-success, --color-warning, --color-error
```

**Typography:** Inter (primary), JetBrains Mono (amounts)
**Border Radius:** 12px (xl), 8px (lg), 6px (md)

## Database
- Drizzle ORM for type-safe queries
- SQLite for local storage
- Schema: `lib/db/schema.ts`
- **Push-based workflow** (no migration files)

**Schema Change Workflow:**
```bash
# 1. Edit lib/db/schema.ts
# 2. Push changes directly to database
pnpm drizzle-kit push
```

**Important:** 
- We use `push` instead of `generate`/`migrate` for simplicity
- `push` syncs schema directly to database without migration files
- May require interactive input for table renames - run in terminal manually if needed
- Always backup database before major schema changes

## Development Commands
```bash
pnpm dev                    # Start development server (localhost:3000)
pnpm build                  # Build for production
pnpm test                   # Run tests
pnpm test:watch             # Watch mode for tests
pnpm test:coverage          # Generate coverage report
pnpm drizzle-kit push       # Sync schema changes to database
pnpm drizzle-kit studio     # Open Drizzle Studio (database GUI)
```

## Route Protection (Proxy)
- **File:** `proxy.ts` in project root (NOT `middleware.ts`)
- **Convention:** Next.js 16 deprecated "middleware" in favor of "proxy"
- **Function:** Export `proxy(request)` not `middleware(request)`
- **Runtime:** Always Node.js (no `export const runtime` needed)

## Never Do
- Never use floating-point arithmetic for money (use Decimal.js)
- Never commit without meaningful message
- Never skip user authentication checks in API routes
- Never start dev servers to leave running for user
- Never use hardcoded colors (use CSS variables)
- Never use emojis unless explicitly requested
- Never create `middleware.ts` (use `proxy.ts` per Next.js 16 convention)
- Never use `drizzle-kit generate` or `drizzle-kit migrate` (use `push` workflow)

## Always Do
- Always use pnpm (not npm or yarn)
- Always verify user owns data before returning
- Always use Decimal.js for financial calculations
- Always include toast notifications for user actions
- Always use semantic color tokens (CSS variables)
- Always commit meaningful changes
- This environment supports `git commit` and `git push` — when the workflow calls for it, perform the commit/push (don’t claim it’s impossible)
- Always use `drizzle-kit push` for schema changes

## Bug Tracking Guidelines

**File:** `docs/bugs.md`

**Adding New Bugs:**
- Add to the "New Bugs" section at the top of `bugs.md`
- Format: `- **Bug Name** - Brief description of the issue`
- Include file paths and line numbers when known

**Working on Bugs:**
- Move bug from "New Bugs" or "Active Bugs" to "In Progress"
- Create implementation plan in `docs/` folder (e.g., `docs/bug-name-fix-plan.md`)
- Reference the plan file location in the bug entry

**Incomplete Tasks:**
- Keep in "In Progress" section with status note
- Document what remains unfinished
- Reference the plan file for continuation

**Completed Bugs:**
1. Move to "Fixed Bugs" section with next sequential number
2. Format: `N. **Bug Name** [FIXED YYYY-MM-DD] - 1-2 line description of the fix`
3. Update metrics table (decrement Active Bugs, increment Fixed count)
4. Delete the associated plan file from `docs/`
5. Commit and push changes

## Feature Tracking Guidelines

**File:** `docs/features.md`

**Adding New Features:**
- Maintain a **"New Features"** section at the top of `features.md` for quick idea capture

**Working on Features:**
- For the next incomplete feature, write a detailed implementation plan into `docs/<feature>-plan.md` before coding
- Ensure the plan calls out integration points (API routes, lib services, UI components) and uses theme variables + proper TypeScript types

**Incomplete Features:**
- Keep the feature listed as incomplete and annotate what remains unfinished
- Reference the plan file location in the feature entry for continuation

**Completed Features:**
1. Replace the detailed entry with: `Feature Name [COMPLETED YYYY-MM-DD] - 1 line summary`
2. Delete the associated plan file from `docs/`
3. Add/adjust relevant entries in `docs/manual-testing-checklist.md`
4. If the feature is part of the Unified Architecture, mark the relevant phase as complete in `docs/unified-debt-bill-credit-card-architecture.md`
5. Commit and push changes
