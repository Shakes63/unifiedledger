---
description: API endpoint patterns, response formats, and common parameters
globs:
  - "app/api/**"
alwaysApply: false
---

# API Patterns

## Standard Response Format
```typescript
// List: { data: [...], total: number, limit: number, offset: number }
// Create: { id: string, ...createdItem }
// Error: { error: string }
```

## Common Parameters
- `limit` (default: 50)
- `offset` (default: 0)
- `sortBy` (field name)
- `sortOrder` (asc|desc)

## Authentication
- All API routes must verify user authentication
- Use Better Auth session validation
- Always verify user owns data before returning
- Include `credentials: "include"` in fetch calls for cookie support

## Household Context
- Core financial data (transactions, accounts, categories, merchants) is household-isolated
- Use `lib/api/household-auth.ts` helpers for household validation
- Frontend should use `lib/hooks/use-household-fetch.ts` for household-aware HTTP methods
- Always filter by `household_id` when querying household-scoped data

## Debug / Test-Only Endpoints
- Any debug-style endpoint that returns sample data or internal diagnostics must be **TEST_MODE-only** (use `isTestMode()` from `lib/test-mode`) and should return **404** when disabled to avoid exposing sensitive data or endpoint discovery.

## Error Handling
- Return consistent error format: `{ error: string }`
- Use appropriate HTTP status codes
- Include helpful error messages for debugging
- Log errors server-side for monitoring

## Enhanced Fetch Utility
- Use `lib/utils/enhanced-fetch.ts` for all fetch calls (replaces standard fetch)
- Features: Exponential backoff retry (3 attempts: 1s, 2s, 4s), timeout handling (10s default), request deduplication, detailed error categorization
- Error types: network, timeout, server, client, abort
- Always returns 200 for performance metrics endpoint (non-blocking operation)
- Graceful auth failures - don't break user experience on auth errors
