---
description: Database schema overview, table relationships, and migration guidelines
globs:
  - "lib/db/**"
  - "drizzle/**"
alwaysApply: false
---

# Database Schema Highlights

## Core Tables
- **users** - User accounts
- **households** - Household groups
- **householdMembers** - User-household relationships with roles
- **accounts** - Financial accounts (household-scoped)
- **budgetCategories** - Budget categories (household-scoped)
- **transactions** - Financial transactions (household-scoped)
- **transactionSplits** - Split transaction details (household-scoped)
- **merchants** - Merchant/payee names (household-scoped)

## Settings Tables
- **userSettings** - User preferences
- **userSessions** - Better Auth sessions
- **user_household_preferences** - Per-household user preferences
- **household_settings** - Shared household settings

## Bills Tables
- **bills** - Recurring bill definitions (household-scoped - Phase 2 ✅ COMPLETE)
- **billInstances** - Individual bill payment instances (household-scoped - Phase 2 ✅ COMPLETE)

## Rules Tables
- **categorizationRules** - Auto-categorization rules
- **ruleExecutionLog** - Rule execution history

## Tags & Custom Fields
- **tags** - Transaction tags
- **transactionTags** - Transaction-tag relationships
- **customFields** - Custom field definitions
- **customFieldValues** - Custom field values

## Goals & Debts
- **savingsGoals** - Savings goal definitions
- **savingsMilestones** - Goal milestones
- **debts** - Debt accounts
- **debtPayments** - Debt payment records
- **debtPayoffMilestones** - Debt payoff milestones

## Tax Tables
- **taxCategories** - Tax category definitions
- **categoryTaxMappings** - Category-tax relationships
- **transactionTaxClassifications** - Transaction tax classifications
- **salesTaxSettings** - Sales tax configuration
- **salesTaxCategories** - Sales tax categories
- **salesTaxTransactions** - Sales tax transaction records
- **quarterlyFilingRecords** - Quarterly filing records

## Notifications
- **notifications** - Notification records
- **notificationPreferences** - User notification preferences
- **householdActivityLog** - Household activity audit trail

## Search & Import
- **savedSearchFilters** - Saved search configurations
- **searchHistory** - Search history
- **importTemplates** - CSV import templates
- **importHistory** - Import history
- **importStaging** - Staging table for imports

## Household Data Isolation
**Phase 1 Complete:** Core financial data is household-scoped:
- `accounts`, `transactions`, `budgetCategories`, `merchants`, `transactionSplits`, `usageAnalytics` all have `household_id`

**Phase 2 Complete (Steps 1-5):** Bills & Budgets data is household-scoped:
- `bills`, `billInstances` have `household_id` (schema updated, migration applied, API endpoints updated)
- `budgetCategories` already had `household_id` (Phase 1)
- All Bills API endpoints (6 files) filter by `household_id`
- All Budgets API endpoints (11 files) filter by `household_id`
- All frontend components (13 components) use `useHouseholdFetch` hook
- Testing complete - household isolation verified

**Remaining:** Phase 2 Step 6 (Documentation & cleanup)

- All queries must filter by `household_id` for household-scoped tables
- Use `lib/api/household-auth.ts` helpers for validation

## Migrations
- Use Drizzle Kit for migrations: `pnpm drizzle-kit generate`
- Apply migrations: `pnpm drizzle-kit migrate`
- Always create database backups before applying migrations
- Test migrations on development database first
